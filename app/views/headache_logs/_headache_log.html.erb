<%
  is_ongoing = headache_log.end_time.nil?
  card_bg_class = is_ongoing ? "bg-warning/5" : "bg-base-100"
  header_bg_class = is_ongoing ? "bg-warning" : "bg-primary"
  header_text_class = is_ongoing ? "text-warning-content" : "text-primary-content"
%>
<%= content_tag :div, id: dom_id(headache_log), class: "rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-all duration-200 #{card_bg_class}" do %>
  <%# Header Bar %>
  <div class="px-4 py-2 <%= header_bg_class %> <%= header_text_class %> flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="text-sm font-semibold">
        <%= headache_log.start_time.strftime("%b %d, %Y Â· %I:%M %p") %>
      </span>
    </div>
    <% if is_ongoing %>
      <span class="text-xs font-medium bg-white/20 px-2 py-0.5 rounded">ONGOING</span>
    <% elsif headache_log.end_time %>
      <span class="text-xs opacity-75">
        <%= heroicon "clock", variant: "mini", class: "w-3 h-3 inline-block" %>
        <%= distance_of_time_in_words(headache_log.end_time, headache_log.start_time) %>
      </span>
    <% end %>
  </div>

  <%# Card Body %>
  <div class="p-4">
    <div class="flex justify-between items-start mb-3">
      <%# Left side content %>
      <div class="flex-1">
        <%# Compact Details Section %>
        <div class="space-y-2">
          <% if headache_log.medication.present? %>
            <div class="bg-primary/5 rounded-lg p-2">
              <div class="flex items-start gap-2">
                <%= heroicon "beaker", variant: "mini", class: "w-4 h-4 text-primary flex-shrink-0 mt-0.5" %>
                <div class="flex flex-wrap gap-1">
                  <% headache_log.medication.split(",").map(&:strip).each do |med| %>
                    <span class="badge badge-primary badge-sm h-auto min-h-[1.5rem] whitespace-normal"><%= med %></span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

          <% if headache_log.triggers.present? %>
            <div class="bg-secondary/5 rounded-lg p-2">
              <div class="flex items-start gap-2">
                <%= heroicon "bolt", variant: "mini", class: "w-4 h-4 text-secondary flex-shrink-0 mt-0.5" %>
                <div class="flex flex-wrap gap-1">
                  <% headache_log.triggers.split(",").map(&:strip).each do |trigger| %>
                    <span class="badge badge-secondary badge-sm h-auto min-h-[1.5rem] whitespace-normal"><%= trigger %></span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>

          <% if headache_log.notes.present? %>
            <div class="bg-base-200 rounded-lg p-2">
              <div class="flex items-start gap-2">
                <%= heroicon "document-text", variant: "mini", class: "w-4 h-4 text-base-content/60 flex-shrink-0 mt-0.5" %>
                <p class="text-xs text-base-content/70 line-clamp-2"><%= headache_log.notes %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Intensity Indicator %>
      <div class="text-center ml-4">
        <%
          # Calculate smooth color interpolation
          intensity_color = if headache_log.intensity <= 3
            'hsl(142, 71%, 45%)' # Green
          elsif headache_log.intensity <= 6
            # Interpolate from green to yellow
            ratio = (headache_log.intensity - 3) / 3.0
            hue = (142 - (ratio * (142 - 45))).round
            saturation = (71 + (ratio * (93 - 71))).round
            lightness = (45 + (ratio * (47 - 45))).round
            "hsl(#{hue}, #{saturation}%, #{lightness}%)"
          else
            # Interpolate from yellow to red
            ratio = (headache_log.intensity - 6) / 4.0
            hue = (45 * (1 - ratio)).round
            saturation = (93 - (ratio * (93 - 84))).round
            lightness = (47 + (ratio * (60 - 47))).round
            "hsl(#{hue}, #{saturation}%, #{lightness}%)"
          end
        %>
        <div class="relative inline-block">
          <div class="radial-progress shadow-sm"
               style="--value:<%= (headache_log.intensity.to_f / 10 * 100).round %>; --size:2.5rem;
                      color: <%= intensity_color %>;">
            <span class="text-base font-bold"><%= headache_log.intensity %></span>
          </div>
          <div class="absolute -inset-1 rounded-full opacity-30 blur-sm"
               style="background-color: <%= intensity_color %>;"></div>
        </div>
        <p class="text-xs text-base-content/60 mt-1">Intensity</p>
      </div>
    </div>

    <%# Actions Section %>
    <div class="flex justify-end gap-1 mt-3 pt-2 border-t border-base-200/50">
      <% unless local_assigns[:hide_actions] %>
        <%= link_to edit_headache_log_path(headache_log),
            class: "btn btn-ghost btn-xs",
            data: { turbo_frame: "_top" } do %>
          <%= heroicon "pencil-square", variant: "mini", class: "w-3 h-3" %>
          Edit
        <% end %>

        <%= button_to headache_log_path(headache_log),
            method: :delete,
            class: "btn btn-ghost btn-xs text-error",
            data: {
              turbo_confirm: "Are you sure you want to delete this headache log?"
            } do %>
          <%= heroicon "trash", variant: "mini", class: "w-3 h-3" %>
          Delete
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>
