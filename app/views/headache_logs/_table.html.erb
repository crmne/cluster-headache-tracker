<%# app/views/headache_logs/_table.html.erb %>
<div class="overflow-x-auto print:overflow-visible">
  <table class="table print:table-sm print:text-xs">
    <thead>
      <tr class="bg-base-200">
        <th>
          <%= heroicon "calendar", variant: "mini", class: "w-4 h-4 inline-block" %>
          Date/Time
        </th>
        <th>
          <%= heroicon "clock", variant: "mini", class: "w-4 h-4 inline-block" %>
          Duration
        </th>
        <th>
          <%= heroicon "chart-bar", variant: "mini", class: "w-4 h-4 inline-block" %>
          Intensity
        </th>
        <th>
          <%= heroicon "beaker", variant: "mini", class: "w-4 h-4 inline-block" %>
          Medication
        </th>
        <th>
          <%= heroicon "bolt", variant: "mini", class: "w-4 h-4 inline-block" %>
          Triggers
        </th>
        <th>
          <%= heroicon "document-text", variant: "mini", class: "w-4 h-4 inline-block" %>
          Notes
        </th>
        <% unless local_assigns[:hide_actions] %>
          <th class="text-right">Actions</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% headache_logs.each do |log| %>
        <%
          is_ongoing = log.end_time.nil?
          row_class = is_ongoing ? "bg-warning/5" : ""
        %>
        <tr class="<%= row_class %>">
          <%# Date and Time %>
          <td class="<%= is_ongoing ? 'border-l-4 border-warning' : '' %>">
            <div class="font-medium"><%= log.start_time.strftime("%B %d, %Y") %></div>
            <div class="text-sm opacity-70">
              <% if log.end_time %>
                <%= log.start_time.strftime("%I:%M %p") %> - <%= log.end_time.strftime("%I:%M %p") %>
              <% else %>
                Started at <%= log.start_time.strftime("%I:%M %p") %>
                <span class="badge badge-warning badge-sm ml-2">Ongoing</span>
              <% end %>
            </div>
          </td>

          <%# Duration %>
          <td>
            <% if log.end_time %>
              <%= distance_of_time_in_words(log.end_time, log.start_time) %>
            <% else %>
              <div data-controller="timer"
                   data-timer-start-value="<%= log.start_time.strftime('%Y-%m-%dT%H:%M:%S') %>"
                   data-timer-format-value="short">
                <span data-timer-target="timeAgo">calculating...</span>
              </div>
            <% end %>
          </td>

          <%# Intensity %>
          <td>
            <div class="flex items-center gap-2">
              <%
                # Calculate smooth color interpolation (matching the card view)
                intensity_color = if log.intensity <= 3
                  'hsl(142, 71%, 45%)' # Green
                elsif log.intensity <= 6
                  # Interpolate from green to yellow
                  ratio = (log.intensity - 3) / 3.0
                  hue = (142 - (ratio * (142 - 45))).round
                  saturation = (71 + (ratio * (93 - 71))).round
                  lightness = (45 + (ratio * (47 - 45))).round
                  "hsl(#{hue}, #{saturation}%, #{lightness}%)"
                else
                  # Interpolate from yellow to red
                  ratio = (log.intensity - 6) / 4.0
                  hue = (45 * (1 - ratio)).round
                  saturation = (93 - (ratio * (93 - 84))).round
                  lightness = (47 + (ratio * (60 - 47))).round
                  "hsl(#{hue}, #{saturation}%, #{lightness}%)"
                end
              %>
              <div class="radial-progress print:hidden"
                  style="--value:<%= (log.intensity.to_f / 10 * 100).round %>; --size:2rem;
                          color: <%= intensity_color %>;">
                <span class="text-sm font-bold"><%= log.intensity %></span>
              </div>
              <%# Only show in print view %>
              <span class="hidden print:inline font-bold"><%= log.intensity %></span>
              <span>/10</span>
            </div>
          </td>

          <%# Medication %>
          <td>
            <% if log.medication.present? %>
              <div class="flex flex-wrap gap-1">
                <% log.medication.split(",").map(&:strip).each do |med| %>
                  <span class="badge badge-primary badge-sm h-auto min-h-[1.5rem] whitespace-normal"><%= med %></span>
                <% end %>
              </div>
            <% else %>
              <span class="opacity-50">None recorded</span>
            <% end %>
          </td>

          <%# Triggers %>
          <td>
            <% if log.triggers.present? %>
              <div class="flex flex-wrap gap-1">
                <% log.triggers.split(",").map(&:strip).each do |trigger| %>
                  <span class="badge badge-secondary badge-sm h-auto min-h-[1.5rem] whitespace-normal"><%= trigger %></span>
                <% end %>
              </div>
            <% else %>
              <span class="opacity-50">None recorded</span>
            <% end %>
          </td>

          <%# Notes %>
          <td>
            <% if log.notes.present? %>
              <div class="max-w-xs overflow-hidden text-sm opacity-70">
                <%= truncate(log.notes, length: 100) %>
              </div>
            <% else %>
              <span class="opacity-50">No notes</span>
            <% end %>
          </td>

          <%# Actions %>
          <% unless local_assigns[:hide_actions] %>
            <td class="text-right">
              <div class="join">
                <%= link_to edit_headache_log_path(log), class: "btn btn-ghost btn-sm join-item" do %>
                  <%= heroicon "pencil-square", variant: "mini", class: "w-4 h-4" %>
                  <span class="sr-only">Edit</span>
                <% end %>

                <%= button_to headache_log_path(log),
                      method: :delete,
                      class: "btn btn-ghost btn-sm btn-error join-item",
                      data: {
                        turbo_confirm: "Are you sure you want to delete this headache log?"
                      } do %>
                  <%= heroicon "trash", variant: "mini", class: "w-4 h-4" %>
                  <span class="sr-only">Delete</span>
                <% end %>
              </div>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
