<%# app/views/headache_logs/_share_link.html.erb %>
<details class="collapse bg-base-200 collapse-arrow shadow join-item" data-accordion="share" <%= 'open' if flash[:generate_link] %>>
  <summary class="collapse-title text-xl font-medium">
    <%= heroicon "share", class: "w-6 h-6 mr-2 inline-block" %>
    Share with Healthcare Provider
  </summary>
  <div class="collapse-content">
    <div class="text-sm opacity-75 mb-4">
      Share your headache logs securely with your healthcare provider.
    </div>

    <% if @share_link && (share_token = current_user.share_tokens.last) %>
      <div class="join join-horizontal w-full mb-4">
        <input type="text" readonly id="share-link" autocomplete="off" value="<%= @share_link %>" class="input input-bordered join-item w-full">
        <button onclick="copyShareLink(this)" class="btn btn-primary join-item min-w-24">
          <%= heroicon "clipboard", variant: "mini", class: "h-4 w-4" %>
          <span>Copy</span>
        </button>
      </div>
      <div class="text-sm opacity-75 mb-4">
        Expires in <%= distance_of_time_in_words(Time.current, share_token.expires_at) %>
      </div>
      <div class="flex flex-col sm:flex-row gap-4">
        <%= button_to expire_share_link_path, method: :delete, class: "btn btn-error btn-outline", data: { turbo_confirm: "Are you sure? This will immediately invalidate the current share link." } do %>
          <%= heroicon "trash", class: "h-4 w-4" %>
          Expire Link
        <% end %>
        <%= button_to generate_share_link_path, class: "btn btn-primary" do %>
          <%= heroicon "plus-circle", class: "h-4 w-4" %>
          Generate New Link
        <% end %>
      </div>
    <% else %>
      <%= button_to generate_share_link_path, class: "btn btn-primary" do %>
        <%= heroicon "plus-circle", class: "h-4 w-4" %>
        Generate Share Link
      <% end %>
    <% end %>
  </div>
</details>

<script>
  // Coordinate accordions
  document.addEventListener('click', function(e) {
    const summary = e.target.closest('summary');
    if (summary) {
      const details = summary.parentElement;
      const otherDetails = document.querySelector(`details[data-accordion]:not([data-accordion="${details.dataset.accordion}"])`);
      if (otherDetails && otherDetails.open) {
        otherDetails.open = false;
      }
    }
  });

  function copyShareLink(button) {
    var copyText = document.getElementById("share-link");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value).then(() => {
      const originalHtml = button.innerHTML;
      button.innerHTML = `
        <%= heroicon "check", variant: "mini", class: "h-4 w-4" %>
        <span>Copied!</span>
      `;
      button.disabled = true;

      setTimeout(() => {
        button.innerHTML = originalHtml;
        button.disabled = false;
      }, 2000);
    });
  }
</script>
