<%= turbo_frame_tag "share_link" do %>
<div class="card bg-base-100 shadow join-item" data-controller="share-link bridge--share">
  <%# Hidden templates for button states %>
  <template data-share-link-target="shareTemplate">
    <%= heroicon "share", variant: "mini", class: "h-4 w-4" %>
    <span>Share</span>
  </template>
  <template data-share-link-target="copiedTemplate">
    <%= heroicon "check", variant: "mini", class: "h-4 w-4" %>
    <span>Copied!</span>
  </template>

  <div class="card-body p-3 sm:p-4">
    <div class="flex items-center justify-between">
      <h3 class="text-sm sm:text-base font-medium flex items-center gap-2">
        <%= heroicon "share", class: "w-5 h-5" %>
        Share with Doctor
      </h3>
      <% if @share_link && current_user.share_tokens.last %>
        <span class="text-xs text-base-content/60">
          Expires in <%= distance_of_time_in_words_to_now(current_user.share_tokens.last.expires_at) %>
        </span>
      <% end %>
    </div>

    <% if @share_link && (share_token = current_user.share_tokens.last) %>
      <div class="flex gap-2 mt-3">
        <input type="text"
               readonly
               data-share-link-target="input"
               autocomplete="off"
               value="<%= @share_link %>"
               class="input input-bordered input-sm flex-1 text-xs">
        <button data-share-link-target="shareButton"
                data-bridge--share-target="shareButton"
                data-action="click->bridge--share#shareViaBridge click->share-link#share"
                data-share-url="<%= @share_link %>"
                data-share-title="My Headache Logs"
                data-share-text="View my headache tracking history"
                class="btn btn-primary btn-sm">
          <%= heroicon "share", variant: "mini", class: "h-4 w-4" %>
          <span>Share</span>
        </button>
        <%= link_to print_headache_logs_path(params.permit(:start_time, :end_time, :triggers, :medication)), class: "btn btn-outline btn-sm", data: { turbo: false } do %>
          <%= heroicon "printer", variant: "mini", class: "w-4 h-4" %>
          <span>Print</span>
        <% end %>
        <%= button_to expire_share_link_path, method: :delete, class: "btn btn-ghost btn-sm text-error" do %>
          <%= heroicon "x-mark", variant: "mini", class: "h-4 w-4" %>
        <% end %>
      </div>
    <% else %>
      <div class="mt-3 flex gap-2">
        <%= button_to generate_share_link_path, class: "btn btn-primary btn-sm flex-1" do %>
          <%= heroicon "plus-circle", class: "h-4 w-4" %>
          Generate Share Link
        <% end %>
        <%= link_to print_headache_logs_path(params.permit(:start_time, :end_time, :triggers, :medication)), class: "btn btn-outline btn-sm", data: { turbo: false } do %>
          <%= heroicon "printer", variant: "mini", class: "w-4 h-4" %>
          <span>Print</span>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
<% end %>
