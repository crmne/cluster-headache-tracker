<%
  # Support both instance variable and local variable
  headache_logs = @headache_logs || current_user.headache_logs.order(start_time: :desc)
%>
<%= turbo_frame_tag "headache_stats" do %>
  <div class="grid">
    <div class="stats stats-vertical md:stats-horizontal print:stats-horizontal shadow print:shadow-none mb-3 print:mb-8 bg-base-100 [&_.stat]:py-3 [&_.stat]:px-4">
    <div class="stat">
      <div class="stat-figure text-info">
        <%= heroicon "clock", class: "inline-block h-6 w-6 sm:h-8 sm:w-8 stroke-current" %>
      </div>
      <div class="stat-title text-xs sm:text-sm">Time Since Last</div>
      <div class="stat-value text-info text-lg sm:text-2xl">
        <% if headache_logs.any? %>
          <div data-controller="timer"
               data-timer-format-value="short"
               data-timer-start-value="<%= headache_logs.max_by(&:start_time).start_time.strftime('%Y-%m-%dT%H:%M:%S') %>">
            <span data-timer-target="timeAgo">...</span>
          </div>
        <% else %>
          <span class="text-info">None yet</span>
        <% end %>
      </div>
      <div class="stat-desc"></div>
    </div>
    <div class="stat">
      <%
        headaches_today = headache_logs.select { |log| log.start_time.to_date == Date.today }.count

        # Calculate color for headaches today (0-8+ scale)
        today_color = if headaches_today == 0
          'hsl(142, 71%, 45%)' # Green - no headaches
        elsif headaches_today <= 2
          # Green range for low count
          'hsl(142, 71%, 45%)'
        elsif headaches_today <= 5
          # Interpolate from green to yellow (2-5)
          ratio = (headaches_today - 2) / 3.0
          hue = (142 - (ratio * (142 - 45))).round
          saturation = (71 + (ratio * (93 - 71))).round
          lightness = (45 + (ratio * (47 - 45))).round
          "hsl(#{hue}, #{saturation}%, #{lightness}%)"
        elsif headaches_today <= 8
          # Interpolate from yellow to red (5-8)
          ratio = (headaches_today - 5) / 3.0
          hue = (45 * (1 - ratio)).round
          saturation = (93 - (ratio * (93 - 84))).round
          lightness = (47 + (ratio * (60 - 47))).round
          "hsl(#{hue}, #{saturation}%, #{lightness}%)"
        else
          # Red for 8+ headaches
          'hsl(0, 84%, 60%)'
        end
      %>
      <div class="stat-figure" style="color: <%= today_color %>;">
        <%= heroicon "sun", class: "inline-block h-6 w-6 sm:h-8 sm:w-8 stroke-current" %>
      </div>
      <div class="stat-title text-xs sm:text-sm">Headaches Today</div>
      <div class="stat-value text-lg sm:text-2xl" style="color: <%= today_color %>;">
        <%= headaches_today %>
      </div>
      <div class="stat-desc"></div>
    </div>
    <div class="stat">
      <%
        avg_intensity = if headache_logs.any?
          (headache_logs.sum(&:intensity).to_f / headache_logs.size).round(1)
        else
          0
        end

        # Calculate color for average intensity - same as cards
        intensity_color = if avg_intensity == 0
          'text-base-content/60'
        elsif avg_intensity <= 3
          'hsl(142, 71%, 45%)' # Green
        elsif avg_intensity <= 6
          # Interpolate from green to yellow
          ratio = (avg_intensity - 3) / 3.0
          hue = (142 - (ratio * (142 - 45))).round
          saturation = (71 + (ratio * (93 - 71))).round
          lightness = (45 + (ratio * (47 - 45))).round
          "hsl(#{hue}, #{saturation}%, #{lightness}%)"
        else
          # Interpolate from yellow to red
          ratio = (avg_intensity - 6) / 4.0
          hue = (45 * (1 - ratio)).round
          saturation = (93 - (ratio * (93 - 84))).round
          lightness = (47 + (ratio * (60 - 47))).round
          "hsl(#{hue}, #{saturation}%, #{lightness}%)"
        end
      %>
      <div class="stat-figure" style="<%= intensity_color.start_with?('hsl') ? "color: #{intensity_color};" : '' %>" class="<%= intensity_color.start_with?('text-') ? intensity_color : '' %>">
        <%= heroicon "chart-bar", class: "inline-block h-6 w-6 sm:h-8 sm:w-8 stroke-current" %>
      </div>
      <div class="stat-title text-xs sm:text-sm">Average Intensity</div>
      <div class="stat-value text-lg sm:text-2xl" style="<%= intensity_color.start_with?('hsl') ? "color: #{intensity_color};" : '' %>" class="<%= intensity_color.start_with?('text-') ? intensity_color : '' %>">
        <%= avg_intensity %>
      </div>
      <div class="stat-desc"></div>
    </div>
  </div>
</div>
<% end %>
